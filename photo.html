<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Offline Photo Editor</title>
    <style>
        /* --- 1. Global & Layout --- */
        :root {
            --bg-dark-1: #121212;
            --bg-dark-2: #1e1e1e;
            --bg-dark-3: #2b2b2b;
            --text-light: #f0f0f0;
            --text-medium: #a0a0a0;
            --accent-blue: #00aaff;
            --accent-red: #ff4444;
            --rating-star: #ffc107; /* Gold color for stars */
            --crop-border: #ff8800; /* Orange for cropping */
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: #000;
            color: var(--text-light);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        #app-container {
            width: 100%;
            height: 100%;
            max-width: 480px; /* Mobile-portrait constraint */
            background: var(--bg-dark-1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        /* --- 2. Preview Area --- */
        #preview-area {
            flex-grow: 1;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background: var(--bg-dark-1);
            padding: 16px;
        }

        #preview-canvas {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 4px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease; /* For smooth crop transition */
        }
        
        /* Crop Overlay Styles */
        #preview-area.cropping #preview-canvas {
            border: 2px dashed var(--crop-border);
            width: var(--crop-width, 100%) !important; 
            height: var(--crop-height, auto) !important;
            object-fit: cover;
            align-self: center; 
        }

        #upload-prompt {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
            border: 2px dashed var(--bg-dark-3);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        #upload-prompt:hover {
            background: var(--bg-dark-2);
            border-color: var(--accent-blue);
        }
        #upload-prompt.hidden {
            display: none;
        }
        #upload-prompt svg {
            width: 48px;
            height: 48px;
            fill: var(--text-medium);
            margin-bottom: 12px;
        }
        #upload-prompt span {
            font-size: 1.1em;
            font-weight: 500;
        }

        #file-input {
            display: none;
        }

        /* --- 3. Filter Stack UI --- */
        #filter-stack-ui {
            display: none; /* Hidden until photo is loaded */
            flex-direction: column;
            background: var(--bg-dark-2);
            padding: 12px 16px;
            border-bottom: 1px solid var(--bg-dark-3);
        }
        .stack-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .stack-header span {
            font-size: 0.9em;
            font-weight: 600;
            color: var(--text-medium);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .header-btn-wrapper {
            display: flex;
            gap: 8px;
        }
        .header-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
        }
        .header-btn svg {
            width: 20px;
            height: 20px;
            fill: var(--text-medium);
            transition: all 0.3s ease;
        }
        #reset-filters-btn svg {
            fill: var(--accent-red);
        }
        #replace-photo-btn svg {
            fill: var(--accent-blue);
        }
        .header-btn:hover svg {
            transform: scale(1.1);
        }
        #reset-filters-btn:hover svg {
            transform: rotate(-90deg) scale(1.1);
        }
        
        #stack-slots {
            display: flex;
            gap: 8px;
        }
        .filter-slot {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 40px;
            background: var(--bg-dark-3);
            border-radius: 6px;
            font-size: 0.9em;
            color: var(--text-medium);
            border: 1px dashed var(--bg-dark-3);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .filter-slot.filled {
            background: var(--accent-blue);
            color: white;
            font-weight: 600;
            border-style: solid;
            border-color: var(--accent-blue);
        }
        .filter-slot .remove-filter-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            background: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.2s ease;
        }
        .filter-slot.filled:hover .remove-filter-btn {
            opacity: 1;
            transform: scale(1);
        }
        .filter-slot .remove-filter-btn svg {
            width: 12px;
            height: 12px;
            fill: var(--accent-red);
        }

        /* --- 4. Main Controls (Tabs & Panels) --- */
        #main-controls {
            flex-shrink: 0;
            background: var(--bg-dark-2);
            border-top: 1px solid var(--bg-dark-3);
        }

        #tab-bar {
            display: flex;
            justify-content: space-around;
            border-bottom: 1px solid var(--bg-dark-3);
        }
        .tab-btn {
            background: none;
            border: none;
            color: var(--text-medium);
            padding: 14px 4px; 
            cursor: pointer;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.75em;
            font-weight: 500;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        .tab-btn svg {
            width: 22px; 
            height: 22px;
            fill: var(--text-medium);
            margin-bottom: 4px;
            transition: all 0.3s ease;
        }
        .tab-btn.active {
            color: var(--accent-blue);
            border-bottom-color: var(--accent-blue);
        }
        .tab-btn.active svg {
            fill: var(--accent-blue);
        }
        .tab-btn:disabled {
            color: #555;
            cursor: not-allowed;
        }
        .tab-btn:disabled svg {
            fill: #555;
        }

        #panels-container {
            height: 240px; /* Fixed height for control panels */
            overflow: hidden;
            position: relative;
        }
        .panel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            padding: 16px;
            visibility: hidden;
            opacity: 0;
            transform: translateX(20px);
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s;
        }
        .panel.active {
            visibility: visible;
            opacity: 1;
            transform: translateX(0);
        }

        /* --- 5. Grid Panels (Filter & Frame) --- */
        #filter-grid, #frame-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 16px 12px; /* Vertical and horizontal gap */
            padding-bottom: 16px; 
        }

        /* Shared Item Styling */
        .grid-item {
            cursor: pointer;
            text-align: center;
            flex-shrink: 0;
        }
        .grid-preview {
            width: 100%; 
            aspect-ratio: 1 / 1; 
            background: linear-gradient(45deg, var(--bg-dark-3), var(--bg-dark-1));
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 2em;
            color: rgba(255,255,255,0.7);
            position: relative;
            overflow: hidden;
        }
        .grid-preview span {
            font-size: 1.5em; 
            opacity: 0.8;
            text-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        .grid-item .item-name {
            display: block;
            font-size: 0.85em;
            font-weight: 500;
            margin-bottom: 4px;
        }
        .grid-item:hover .grid-preview {
            border-color: var(--accent-blue);
            transform: scale(1.05);
        }
        .grid-item.active .grid-preview {
            border-color: var(--accent-blue);
        }
        
        /* Frame Specific Preview Styles */
        .frame-preview {
            background: linear-gradient(45deg, #1e1e1e, #121212);
        }
        /* Polaroid Preview - Adjusted for better visual representation */
        .frame-preview[data-key="polaroid"] {
            border-bottom: 30px solid white;
            border-left: 5px solid white;
            border-right: 5px solid white;
            border-top: 5px solid white;
            border-radius: 0;
            background: #1e1e1e;
        }
        .frame-preview[data-key="none"] {
            background: transparent;
            border: 2px dashed var(--bg-dark-3);
        }

        /* --- 6. Crop Panel --- */
        #crop-panel {
            padding: 16px;
        }
        #ratio-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            padding-bottom: 16px;
        }
        .ratio-item {
            cursor: pointer;
            text-align: center;
        }
        .ratio-preview {
            width: 100%;
            height: 60px;
            border: 2px solid var(--bg-dark-3);
            border-radius: 6px;
            margin-bottom: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8em;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .ratio-item.active .ratio-preview {
            border-color: var(--accent-blue);
            background: rgba(0, 170, 255, 0.1);
        }

        /* --- 7. Adjustment Panel --- */
        .adjustment-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
        }
        .adjustment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        input[type="range"] {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            background: var(--bg-dark-3);
            border-radius: 4px;
            cursor: pointer;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 18px;
            width: 18px;
            border-radius: 50%;
            background: var(--accent-blue);
            cursor: grab;
            box-shadow: 0 0 5px rgba(0, 170, 255, 0.5);
        }

        /* --- 8. Text Panel (POLISHED) --- */
        .form-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 16px; /* Increased margin for spacing */
        }
        .form-group label {
            font-size: 0.9em;
            margin-bottom: 6px;
            color: var(--text-medium);
        }
        
        /* General Input/Select Styling */
        input[type="text"], input[type="number"], select {
            background: var(--bg-dark-3);
            border: 1px solid var(--bg-dark-3);
            color: var(--text-light);
            padding: 8px 12px; /* Smaller padding */
            border-radius: 4px;
            font-size: 1em; /* Standard size */
            max-width: 100%; /* Ensure inputs don't overflow */
        }

        .row {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }
        .row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        /* Color Input Styling */
        .color-input-wrapper {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        #color-input {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 40px;
            height: 40px;
            padding: 0;
            border: 1px solid var(--bg-dark-3);
            background: var(--bg-dark-3);
            cursor: pointer;
        }
        #color-input::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        #color-input::-webkit-color-swatch {
            border: none;
        }
        #color-hex-input {
            flex-grow: 1;
            text-transform: uppercase;
        }

        /* Position Buttons (Grid Layout) */
        .position-controls {
            display: grid;
            grid-template-columns: repeat(3, 50px); /* Smaller buttons */
            grid-template-rows: repeat(3, 50px);
            gap: 4px;
            max-width: 154px; /* Constrain the control block */
            margin-top: 4px;
        }
        .position-controls button {
            background: var(--bg-dark-3);
            border: none;
            border-radius: 4px;
            color: var(--text-medium);
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background 0.2s;
            padding: 0; /* Remove padding */
            width: 100%;
            height: 100%;
        }
        .position-controls button:hover {
            background: var(--accent-blue);
            color: white;
        }
        .position-controls button svg {
            width: 20px; /* Smaller icon */
            height: 20px;
            fill: currentColor;
        }
        /* Grid mapping for arrow buttons */
        #btn-pos-up { grid-area: 1 / 2 / 2 / 3; }
        #btn-pos-down { grid-area: 3 / 2 / 4 / 3; }
        #btn-pos-left { grid-area: 2 / 1 / 3 / 2; }
        #btn-pos-right { grid-area: 2 / 3 / 3 / 4; }
        #btn-pos-center { grid-area: 2 / 2 / 3 / 3; }


        /* --- 9. Download Panel --- */
        #download-panel {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            gap: 16px;
        }
        .download-btn {
            background: var(--accent-blue);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.3s;
        }
        .download-btn svg {
            width: 24px;
            height: 24px;
            fill: white;
        }
        .download-btn:hover {
            background: #0088cc;
        }
        #download-panel p {
            font-size: 0.9em;
            color: var(--text-medium);
        }
        
        /* --- 10. Download Modal (POLISHED) --- */
        #modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s;
            z-index: 1000;
        }
        #modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        #modal-content {
            background: var(--bg-dark-2);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            max-width: 350px;
            width: 90%;
            text-align: center;
        }
        #modal-content h3 {
            margin-bottom: 15px;
            font-size: 1.5em;
            color: var(--text-light);
        }
        #modal-content p {
            margin-bottom: 25px;
            color: var(--text-medium);
            font-size: 1em;
            /* Hide the raw calculating size text until calculated */
            display: none; 
        }
        #modal-content p.visible {
            display: block; 
        }

        #modal-actions {
            display: flex;
            justify-content: space-around;
            gap: 10px;
        }
        .modal-btn {
            flex: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        #modal-cancel-btn {
            background: var(--bg-dark-3);
            color: var(--text-light);
        }
        #modal-cancel-btn:hover {
            background: #444;
        }
        #modal-confirm-btn {
            background: var(--accent-blue);
            color: white;
        }
        #modal-confirm-btn:hover {
            background: #0088cc;
        }
    </style>
</head>
<body>

    <svg width="0" height="0" style="position:absolute">
        <defs>
            <symbol id="icon-upload" viewBox="0 0 24 24">
                <path d="M9 16h6v-6h4l-7-7-7 7h4v6zm-4 4h14v-2H5v2z"/>
            </symbol>
            <symbol id="icon-filters" viewBox="0 0 24 24">
                <path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z"/>
            </symbol>
            <symbol id="icon-crop" viewBox="0 0 24 24">
                <path d="M17 15h2V7c0-1.1-.9-2-2-2H9v2h8v8zm-7 0H7v-3H5v3c0 1.1.9 2 2 2h3v2h2v-5zM21 5c0-1.1-.9-2-2-2h-8c-.55 0-1 .45-1 1s.45 1 1 1h8v8c0 .55.45 1 1 1s1-.45 1-1V5zM5 19h2v-3h2v3h3v2H7c-1.1 0-2-.9-2-2v-3H3v-2h2v5z"/>
            </symbol>
            <symbol id="icon-frame" viewBox="0 0 24 24">
                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-1 16H6V5h13l.01 14z"/>
            </symbol>
            <symbol id="icon-adjust" viewBox="0 0 24 24">
                <path d="M12 18h2v-2h-2v2zm0-10v2h2V8h-2zM4 14h8V6H4v8zM3 4v16h18V4H3zm16 14h-2v-2h2v2zM19 14h-2v-2h2v2zM19 8h-2V6h2v2z"/>
            </symbol>
            <symbol id="icon-text" viewBox="0 0 24 24">
                <path d="M2.5 4v3h5v12h3V7h5V4h-13zm19 5h-9v3h3v7h3v-7h3V9z"/>
            </symbol>
            <symbol id="icon-download" viewBox="0 0 24 24">
                <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
            </symbol>
            <symbol id="icon-x" viewBox="0 0 24 24">
                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/>
            </symbol>
            <symbol id="icon-reset" viewBox="0 0 24 24">
                <path d="M12 6v3l4-4-4-4v3c-4.42 0-8 3.58-8 8 0 1.57.46 3.03 1.24 4.26L6.7 14.8c-.45-.83-.7-1.79-.7-2.8 0-3.31 2.69-6 6-6zm6.76 1.74L17.3 9.2c.44.84.7 1.79.7 2.8 0 3.31-2.69 6-6 6v-3l-4 4 4 4v-3c4.42 0 8-3.58 8-8 0-1.57-.46-3.03-1.24-4.26z"/>
            </symbol>
            <symbol id="icon-replace" viewBox="0 0 24 24">
                <path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V6h5.17l2 2H20v10z"/>
            </symbol>
            <symbol id="icon-arrow-up" viewBox="0 0 24 24">
                <path d="m7 14 5-5 5 5H7z"/>
            </symbol>
            <symbol id="icon-arrow-down" viewBox="0 0 24 24">
                <path d="m7 10 5 5 5-5H7z"/>
            </symbol>
            <symbol id="icon-arrow-left" viewBox="0 0 24 24">
                <path d="M14 7l-5 5 5 5V7z"/>
            </symbol>
            <symbol id="icon-arrow-right" viewBox="0 0 24 24">
                <path d="M10 17l5-5-5-5v10z"/>
            </symbol>
            <symbol id="icon-center" viewBox="0 0 24 24">
                <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm-7 11H3v-2h2v2zm0-4H3v-2h2v2zm0-4H3V9h2v2zm0-4H3V5h2v2zm4 16H5v-2h2v2zm12 0h-2v-2h2v2zM7 21h2v-2H7v2zm4 0h2v-2h-2v2zm4 0h2v-2h-2v2zm4-4h-2v-2h2v2zm0-12h-2V9h2v2zm0 8h-2v-2h2v2zm0-4h-2v-2h2v2zm-4-8H9V3h2v2z"/>
            </symbol>
        </defs>
    </svg>

    <div id="app-container">
        
        <div id="preview-area">
            <canvas id="preview-canvas"></canvas>
            <label id="upload-prompt" for="file-input">
                <svg><use href="#icon-upload"></use></svg>
                <span>Tap to Upload Photo</span>
            </label>
            <input type="file" id="file-input" accept="image/*">
        </div>

        <div id="filter-stack-ui">
            <div class="stack-header">
                <span>Active Filters</span>
                <div class="header-btn-wrapper">
                    <button id="replace-photo-btn" class="header-btn" title="Replace photo">
                        <svg><use href="#icon-replace"></use></svg>
                    </button>
                    <button id="reset-filters-btn" class="header-btn" title="Reset all filters">
                        <svg><use href="#icon-reset"></use></svg>
                    </button>
                </div>
            </div>
            <div id="stack-slots">
                <div class="filter-slot" data-index="0">Empty</div>
                <div class="filter-slot" data-index="1">Empty</div>
                <div class="filter-slot" data-index="2">Empty</div>
            </div>
        </div>

        <div id="main-controls">
            <nav id="tab-bar">
                <button class="tab-btn active" data-panel="filter-panel" id="tab-filters" disabled>
                    <svg><use href="#icon-filters"></use></svg>
                    Filters
                </button>
                <button class="tab-btn" data-panel="crop-panel" id="tab-crop" disabled>
                    <svg><use href="#icon-crop"></use></svg>
                    Crop
                </button>
                <button class="tab-btn" data-panel="frame-panel" id="tab-frames" disabled>
                    <svg><use href="#icon-frame"></use></svg>
                    Frames
                </button>
                <button class="tab-btn" data-panel="adjustment-panel" id="tab-adjust" disabled>
                    <svg><use href="#icon-adjust"></use></svg>
                    Adjust
                </button>
                <button class="tab-btn" data-panel="text-panel" id="tab-text" disabled>
                    <svg><use href="#icon-text"></use></svg>
                    Text
                </button>
                <button class="tab-btn" data-panel="download-panel" id="tab-download" disabled>
                    <svg><use href="#icon-download"></use></svg>
                    Download
                </button>
            </nav>

            <div id="panels-container">
                <div class="panel active" id="filter-panel">
                    <div id="filter-grid">
                        </div>
                </div>
                
                <div class="panel" id="crop-panel">
                    <div id="ratio-grid">
                        </div>
                </div>

                <div class="panel" id="frame-panel">
                    <div id="frame-grid">
                        </div>
                </div>

                <div class="panel" id="adjustment-panel">
                    <div class="adjustment-group">
                        <div class="adjustment-header">
                            <label for="brightness-slider">Brightness</label>
                            <span id="brightness-value">100%</span>
                        </div>
                        <input type="range" id="brightness-slider" min="50" max="150" value="100" step="1">
                    </div>
                    <div class="adjustment-group">
                        <div class="adjustment-header">
                            <label for="contrast-slider">Contrast</label>
                            <span id="contrast-value">100%</span>
                        </div>
                        <input type="range" id="contrast-slider" min="50" max="150" value="100" step="1">
                    </div>
                    <div class="adjustment-group">
                        <div class="adjustment-header">
                            <label for="saturation-slider">Saturation</label>
                            <span id="saturation-value">100%</span>
                        </div>
                        <input type="range" id="saturation-slider" min="0" max="200" value="100" step="1">
                    </div>
                    <div class="adjustment-group">
                        <div class="adjustment-header">
                            <label for="sepia-slider">Sepia</label>
                            <span id="sepia-value">0%</span>
                        </div>
                        <input type="range" id="sepia-slider" min="0" max="100" value="0" step="1">
                    </div>
                </div>

                <div class="panel" id="text-panel">
                    <div class="form-group">
                        <label for="text-input">Your Text</label>
                        <input type="text" id="text-input" placeholder="Enter text here..." maxlength="50">
                    </div>
                    <div class="row">
                        <div class="form-group">
                            <label for="font-select">Font Family</label>
                            <select id="font-select">
                                <option value="Arial">Arial</option>
                                <option value="Verdana">Verdana</option>
                                <option value="Georgia">Georgia</option>
                                <option value="Times New Roman">Times New Roman</option>
                                <option value="Courier New">Courier New</option>
                                <option value="Impact">Impact</option>
                                <option value="Comic Sans MS">Comic Sans MS</option>
                                <option value="Trebuchet MS">Trebuchet MS</option>
                                <option value="Lucida Console">Lucida Console</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="font-size-input">Size</label>
                            <input type="number" id="font-size-input" value="40" min="8" max="200">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="color-input">Color</label>
                        <div class="color-input-wrapper">
                            <input type="color" id="color-input" value="#FFFFFF">
                            <input type="text" id="color-hex-input" value="#FFFFFF" maxlength="7">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Position</label>
                        <div class="position-controls">
                            <button id="btn-pos-up" title="Move Up"><svg><use href="#icon-arrow-up"></use></svg></button>
                            <button id="btn-pos-left" title="Move Left"><svg><use href="#icon-arrow-left"></use></svg></button>
                            <button id="btn-pos-center" title="Center"><svg><use href="#icon-center"></use></svg></button>
                            <button id="btn-pos-right" title="Move Right"><svg><use href="#icon-arrow-right"></use></svg></button>
                            <button id="btn-pos-down" title="Move Down"><svg><use href="#icon-arrow-down"></use></svg></button>
                        </div>
                    </div>
                </div>

                <div class="panel" id="download-panel">
                    <button class="download-btn" id="generate-download-btn">
                        <svg><use href="#icon-download"></use></svg>
                        Generate & Download
                    </button>
                    <p>Click to prepare your image for download.</p>
                </div>
            </div>
        </div>

    </div>

    <div id="modal-overlay">
        <div id="modal-content">
            <h3>Confirm Download</h3>
            <p id="file-size-info"></p> 
            <div id="modal-actions">
                <button class="modal-btn" id="modal-cancel-btn">Cancel</button>
                <button class="modal-btn" id="modal-confirm-btn">Download</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- 1. DOM Elements ---
            const fileInput = document.getElementById('file-input');
            const uploadPrompt = document.getElementById('upload-prompt');
            const previewArea = document.getElementById('preview-area');
            const canvas = document.getElementById('preview-canvas');
            const ctx = canvas.getContext('2d');
            
            const filterStackUI = document.getElementById('filter-stack-ui');
            const stackSlots = document.querySelectorAll('.filter-slot');
            const resetFiltersBtn = document.getElementById('reset-filters-btn');
            const replacePhotoBtn = document.getElementById('replace-photo-btn');

            const tabButtons = document.querySelectorAll('.tab-btn');
            const panels = document.querySelectorAll('.panel');
            
            const filterGrid = document.getElementById('filter-grid');
            const frameGrid = document.getElementById('frame-grid');
            const ratioGrid = document.getElementById('ratio-grid');
            
            // Adjustment Sliders
            const brightnessSlider = document.getElementById('brightness-slider');
            const contrastSlider = document.getElementById('contrast-slider');
            const saturationSlider = document.getElementById('saturation-slider');
            const sepiaSlider = document.getElementById('sepia-slider');
            
            const brightnessValue = document.getElementById('brightness-value');
            const contrastValue = document.getElementById('contrast-value');
            const saturationValue = document.getElementById('saturation-value');
            const sepiaValue = document.getElementById('sepia-value');
            
            const textInput = document.getElementById('text-input');
            const fontSelect = document.getElementById('font-select');
            const fontSizeInput = document.getElementById('font-size-input');
            const colorInput = document.getElementById('color-input');
            const colorHexInput = document.getElementById('color-hex-input');
            
            const btnPosUp = document.getElementById('btn-pos-up');
            const btnPosDown = document.getElementById('btn-pos-down');
            const btnPosLeft = document.getElementById('btn-pos-left');
            const btnPosRight = document.getElementById('btn-pos-right');
            const btnPosCenter = document.getElementById('btn-pos-center');

            const generateDownloadBtn = document.getElementById('generate-download-btn');
            const modalOverlay = document.getElementById('modal-overlay');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            const fileSizeInfo = document.getElementById('file-size-info');

            // --- 2. State Variables ---
            let originalImage = null;
            let activeFilters = []; // Max 3
            let activeFrame = 'none';
            let activeRatio = 'free'; 
            let adjustmentSettings = {
                brightness: 100,
                contrast: 100,
                saturation: 100,
                sepia: 0
            };
            let textSettings = {
                content: '',
                font: 'Arial',
                size: 40,
                color: '#FFFFFF',
                pos: { x: 0, y: 0 }
            };
            let downloadBlobUrl = null;

            // --- 3. Filter Definitions (100 Total) ---
            const filterDefinitions = {
                'vanilla':          { name: 'Vanilla', css: 'none', rating: 5 },
                'cinematic':        { name: 'Cinematic', css: 'contrast(1.1) brightness(0.9) sepia(0.3)', rating: 4.5 },
                'x-pro':            { name: 'X-Pro', css: 'sepia(0.3) contrast(1.5) brightness(0.8) hue-rotate(-15deg) saturate(1.2)', rating: 4.8 },
                'polaroid':         { name: 'Old Polaroid', css: 'sepia(0.4) contrast(1.2) brightness(0.9) saturate(1.1)', rating: 3.5 },
                'dynamic':          { name: 'Dynamic', css: 'contrast(1.3) saturate(1.2)', rating: 4.2 },
                'hdr':              { name: 'HDR', css: 'saturate(1.6) contrast(1.3) brightness(0.9)', rating: 4.7 },
                'blur':             { name: 'Soft Blur', css: 'blur(3px)', rating: 3.0 },
                'warm':             { name: 'Warm Tone', css: 'sepia(0.2) brightness(1.05)', rating: 4.0 },
                'soft':             { name: 'Soft Focus', css: 'brightness(1.1) contrast(0.9)', rating: 4.1 },
                'film':             { name: 'Film Grain', css: 'contrast(1.2) brightness(0.8) saturate(1.1)', rating: 4.5 },
                'vintage':          { name: 'Vintage', css: 'sepia(0.6) contrast(0.9) brightness(0.9) hue-rotate(-10deg)', rating: 3.9 },
                'lomo':             { name: 'Lomo', css: 'contrast(1.4) saturate(1.3) hue-rotate(-5deg)', rating: 3.8 },
                'mono':             { name: 'Monochrome', css: 'grayscale(1)', rating: 4.5 },
                'fade':             { name: 'Fade', css: 'grayscale(1) contrast(1.1) brightness(1.1)', rating: 4.3 },
                'noir':             { name: 'Noir', css: 'grayscale(1) contrast(1.3) brightness(0.8)', rating: 4.6 },
                'vibrant':          { name: 'Vibrant', css: 'saturate(1.8) contrast(1.1)', rating: 4.2 },
                'cool':             { name: 'Cool Tone', css: 'hue-rotate(10deg) brightness(1.05)', rating: 3.5 },
                'aqua':             { name: 'Aqua', css: 'sepia(0.2) hue-rotate(180deg) saturate(1.2)', rating: 3.7 },
                'sunset':           { name: 'Sunset', css: 'sepia(0.3) hue-rotate(-20deg) contrast(1.1)', rating: 4.1 },
                'forest':           { name: 'Forest', css: 'sepia(0.1) hue-rotate(40deg) contrast(1.1) saturate(1.2)', rating: 3.9 },
                'dreamy':           { name: 'Dreamy', css: 'brightness(1.2) contrast(0.9) saturate(1.1) blur(1px)', rating: 4.0 },
                'deep':             { name: 'Deep', css: 'contrast(1.4) brightness(0.8)', rating: 4.4 },
                'rose':             { name: 'Rose Tint', css: 'sepia(0.2) hue-rotate(-15deg) saturate(1.1)', rating: 3.6 },
                'frost':            { name: 'Frost', css: 'brightness(1.1) contrast(1.1) saturate(0) sepia(0.1) hue-rotate(200deg)', rating: 3.4 },
                'invert':           { name: 'Invert', css: 'invert(1)', rating: 2.5 },
                'sharp':            { name: 'Sharpen', css: 'contrast(1.5)', rating: 4.3 },
                'gotham':           { name: 'Gotham', css: 'grayscale(1) contrast(1.4) brightness(0.9)', rating: 4.7 },
                'pop':              { name: 'Pop Art', css: 'saturate(2.5) contrast(1.5)', rating: 3.0 },
                'misty':            { name: 'Misty', css: 'brightness(1.1) contrast(0.8) sepia(0.1)', rating: 3.8 },
                'rustic':           { name: 'Rustic', css: 'sepia(0.7) contrast(1.1) saturate(1.1)', rating: 4.1 },
                'vignette':         { name: 'Vignette Focus', css: 'brightness(1.1) contrast(1.1) sepia(0.15)', rating: 4.0 },
                'hybrid':           { name: 'Hybrid', css: 'contrast(1.2) brightness(0.9) saturate(1.3) hue-rotate(5deg)', rating: 4.4 },
                'dizzy':            { name: 'Dizzy', css: 'hue-rotate(30deg) contrast(1.1) saturate(1.8)', rating: 2.8 },
                'toxic':            { name: 'Toxic', css: 'brightness(0.8) contrast(1.2) hue-rotate(90deg) saturate(1.5)', rating: 3.1 },
                'saturated film':   { name: 'Saturated Film', css: 'sepia(0.1) saturate(2) contrast(1.2) brightness(1.05)', rating: 4.6 },
                'romantic spring':  { name: 'Romantic Spring', css: 'sepia(0.1) brightness(1.1) contrast(0.9) saturate(1.3) hue-rotate(-5deg)', rating: 4.3 },
                'high key':         { name: 'High Key', css: 'brightness(1.4) contrast(0.8)', rating: 3.5 },
                'low key':          { name: 'Low Key', css: 'brightness(0.7) contrast(1.5)', rating: 3.9 },
                'blue crush':       { name: 'Blue Crush', css: 'hue-rotate(200deg) contrast(1.1) brightness(0.9) saturate(1.5)', rating: 4.0 },
                'red shift':        { name: 'Red Shift', css: 'hue-rotate(-20deg) contrast(1.2) saturate(1.1)', rating: 3.7 },
                'green pop':        { name: 'Green Pop', css: 'hue-rotate(60deg) saturate(1.4)', rating: 3.2 },
                'cross process':    { name: 'Cross Process', css: 'sepia(0.3) contrast(1.3) brightness(0.8) hue-rotate(-20deg)', rating: 4.5 },
                'old gold':         { name: 'Old Gold', css: 'sepia(0.8) contrast(1.1) saturate(1.2)', rating: 4.1 },
                'faded film':       { name: 'Faded Film', css: 'sepia(0.5) contrast(1.1) brightness(1.1) saturate(0.8)', rating: 4.0 },
                'soft glow':        { name: 'Soft Glow', css: 'brightness(1.1) blur(1.5px) contrast(0.9)', rating: 4.2 },
                'crisp':            { name: 'Crisp', css: 'contrast(1.6) brightness(1.05) saturate(1.1)', rating: 4.5 },
                'cyberpunk':        { name: 'Cyberpunk', css: 'contrast(1.5) saturate(2) hue-rotate(280deg) brightness(0.8)', rating: 3.3 },
                'sun flare':        { name: 'Sun Flare', css: 'brightness(1.2) sepia(0.5) contrast(1.1)', rating: 3.9 },
                'dark mood':        { name: 'Dark Mood', css: 'brightness(0.6) contrast(1.2) saturate(0.9)', rating: 4.3 },
                'light leak':       { name: 'Light Leak', css: 'contrast(1.1) brightness(1.1) saturate(1.2) hue-rotate(-10deg)', rating: 4.1 },
                'velvet':           { name: 'Velvet', css: 'brightness(0.9) contrast(0.9) sepia(0.1) blur(0.5px)', rating: 4.4 },
                'grungy':           { name: 'Grungy', css: 'Grungy', css: 'grayscale(0.5) contrast(1.4) brightness(0.7) sepia(0.2)', rating: 3.7 },
                'chrome':           { name: 'Chrome', css: 'grayscale(1) contrast(1.5) brightness(1.1)', rating: 3.5 },
                'summer day':       { name: 'Summer Day', css: 'saturate(1.4) contrast(1.1) brightness(1.1) sepia(0.1)', rating: 4.6 },
                'winter mist':      { name: 'Winter Mist', css: 'grayscale(0.3) brightness(1.1) contrast(0.95) hue-rotate(180deg)', rating: 3.6 },
                'warm portrait':    { name: 'Warm Portrait', css: 'brightness(1.1) contrast(1.05) saturate(1.1) sepia(0.15)', rating: 4.8 },
                'paint':            { name: 'Oil Paint', css: 'brightness(1.1) contrast(0.9) saturate(1.1) blur(2px) sepia(0.1)', rating: 3.5 },
                'canvas':           { name: 'Canvas Texture', css: 'brightness(1.05) contrast(1.1) sepia(0.2)', rating: 3.9 },
                'night':            { name: 'Night Mode', css: 'brightness(0.7) contrast(1.2) saturate(1.3) hue-rotate(200deg) sepia(0.1)', rating: 4.6 },
                'warm_orange':      { name: 'Warm Orange', css: 'sepia(0.4) saturate(1.2) contrast(1.1) hue-rotate(-10deg)', rating: 4.0 }, 
                'summer_vibe':      { name: 'Summer Vibe', css: 'saturate(1.5) contrast(1.15) brightness(1.1)', rating: 4.7 },
                'winter_chill':     { name: 'Winter Chill', css: 'brightness(1.05) contrast(0.9) saturate(1.3) hue-rotate(180deg)', rating: 4.1 },
                'glow':             { name: 'Soft Glow', css: 'brightness(1.2) contrast(0.9) saturate(1.1) blur(1px) sepia(0.1)', rating: 4.2 },
                'moody':            { name: 'Moody', css: 'brightness(0.8) contrast(1.3) saturate(1.1) sepia(0.1)', rating: 4.5 },
                'infrared':         { name: 'Infrared', css: 'hue-rotate(240deg) contrast(1.5) brightness(0.8) sepia(0.5)', rating: 3.3 },
                'clean':            { name: 'Clean', css: 'Clean', css: 'contrast(1.05) brightness(1.05) saturate(1.1)', rating: 4.9 },
                'classic_bw':       { name: 'Classic BW', css: 'grayscale(1) contrast(1.2) brightness(1.0)', rating: 4.6 },
                'sepia_tone':       { name: 'Sepia Tone', css: 'sepia(1) contrast(1.1) brightness(0.9)', rating: 3.8 },
                'dark_sepia':       { name: 'Dark Sepia', css: 'sepia(0.8) contrast(1.3) brightness(0.7)', rating: 4.1 },
                'pastel':           { name: 'Pastel', css: 'saturate(0.8) brightness(1.15) contrast(0.95)', rating: 3.7 },
                'electric':         { name: 'Electric', css: 'saturate(2) contrast(1.2) hue-rotate(50deg)', rating: 3.5 },
                'retro':            { name: 'Retro', css: 'sepia(0.5) contrast(1.2) brightness(0.85)', rating: 4.0 },
                'pink_pop':         { name: 'Pink Pop', css: 'hue-rotate(300deg) saturate(1.5) contrast(1.1)', rating: 3.6 },
                'teal_orange':      { name: 'Teal & Orange', css: 'contrast(1.2) saturate(1.5) hue-rotate(190deg) sepia(0.2)', rating: 4.7 },
                'bleach_bypass':    { name: 'Bleach Bypass', css: 'grayscale(0.7) contrast(1.5) brightness(0.8)', rating: 4.4 },
                'high_saturation':  { name: 'High Saturation', css: 'saturate(2.2) contrast(1.1)', rating: 3.9 },
                'low_saturation':   { name: 'Low Saturation', css: 'saturate(0.6) brightness(1.1)', rating: 3.5 },
                'dark_contrast':    { name: 'Dark Contrast', css: 'brightness(0.7) contrast(1.5)', rating: 4.2 },
                'light_contrast':   { name: 'Light Contrast', css: 'brightness(1.3) contrast(0.8)', rating: 3.4 },
                'natural':          { name: 'Natural', css: 'contrast(1.0) brightness(1.0) saturate(1.0)', rating: 5.0 },
                'grayscale_sepia':  { name: 'Grayscale Sepia', css: 'grayscale(1) sepia(0.5)', rating: 4.0 },
                'deep_blue':        { name: 'Deep Blue', css: 'brightness(0.8) contrast(1.2) saturate(1.5) hue-rotate(240deg)', rating: 4.3 },
                'purple_haze':      { name: 'Purple Haze', css: 'hue-rotate(280deg) contrast(1.1) brightness(0.9) saturate(1.3)', rating: 3.7 },
                'vivid_warm':       { name: 'Vivid Warm', css: 'contrast(1.2) brightness(1.1) saturate(1.5) sepia(0.2)', rating: 4.8 },
                'aqua_fade':        { name: 'Aqua Fade', css: 'brightness(1.05) contrast(0.95) saturate(1.2) hue-rotate(170deg)', rating: 3.8 },
                'blue_black':       { name: 'Blue Black', css: 'brightness(0.7) contrast(1.3) saturate(1.3) hue-rotate(210deg)', rating: 4.4 },
                'bright_green':     { name: 'Bright Green', css: 'saturate(2.0) contrast(1.1) hue-rotate(90deg)', rating: 3.2 },
                'bright_red':       { name: 'Bright Red', css: 'saturate(2.0) contrast(1.1) hue-rotate(-20deg)', rating: 3.5 },
                'bw_high_key':      { name: 'BW High Key', css: 'grayscale(1) brightness(1.3) contrast(0.8)', rating: 4.0 },
                'bw_low_key':       { name: 'BW Low Key', css: 'grayscale(1) brightness(0.7) contrast(1.4)', rating: 4.1 },
                'classic_vivid':    { name: 'Classic Vivid', css: 'saturate(1.3) contrast(1.1) brightness(1.05)', rating: 4.7 },
                'cool_contrast':    { name: 'Cool Contrast', css: 'contrast(1.2) brightness(0.9) hue-rotate(190deg) saturate(1.1)', rating: 4.5 },
                'copper':           { name: 'Copper', css: 'sepia(0.6) contrast(1.1) brightness(1.05) hue-rotate(-30deg)', rating: 3.9 },
                'dark_sepia_bw':    { name: 'Dark Sepia BW', css: 'grayscale(1) sepia(0.7) contrast(1.2) brightness(0.8)', rating: 4.2 },
                'dream_pop':        { name: 'Dream Pop', css: 'saturate(1.5) contrast(0.9) blur(1px) hue-rotate(-10deg)', rating: 3.7 },
                'early_morning':    { name: 'Early Morning', css: 'brightness(1.15) contrast(0.95) saturate(1.1) hue-rotate(5deg)', rating: 4.3 },
                'film_blue':        { name: 'Film Blue', css: 'contrast(1.2) brightness(0.8) saturate(1.2) hue-rotate(10deg)', rating: 4.5 },
                'golden_hour':      { name: 'Golden Hour', css: 'sepia(0.3) brightness(1.1) contrast(1.05) hue-rotate(-15deg)', rating: 4.8 },
                'high_noon':        { name: 'High Noon', css: 'brightness(1.3) contrast(1.1) saturate(1.2)', rating: 4.1 },
                'intense_red':      { name: 'Intense Red', css: 'brightness(0.9) contrast(1.4) saturate(1.8) hue-rotate(-30deg)', rating: 3.4 },
                'light_sepia':      { name: 'Light Sepia', css: 'sepia(0.5) brightness(1.1) contrast(0.95)', rating: 4.0 },
                'low_fidelity':     { name: 'Low Fidelity', css: 'contrast(0.8) brightness(1.2) saturate(0.8)', rating: 3.6 },
                'matte_fade':       { name: 'Matte Fade', css: 'contrast(0.9) brightness(1.05) saturate(0.9) sepia(0.1)', rating: 4.4 },
                'neon_green':       { name: 'Neon Green', css: 'saturate(2.5) contrast(1.2) hue-rotate(120deg)', rating: 3.1 },
                'oceanic':          { name: 'Oceanic', css: 'contrast(1.1) brightness(0.95) hue-rotate(220deg) saturate(1.4)', rating: 4.2 },
                'pale_skin':        { name: 'Pale Skin', css: 'brightness(1.1) contrast(0.9) saturate(0.8) sepia(0.1)', rating: 3.5 },
                'punchy':           { name: 'Punchy', css: 'contrast(1.5) saturate(1.5) brightness(1.05)', rating: 4.6 },
                'soft_bw':          { name: 'Soft BW', css: 'grayscale(1) brightness(1.1) contrast(0.9)', rating: 4.3 },
                'sunny_yellow':     { name: 'Sunny Yellow', css: 'brightness(1.2) sepia(0.4) hue-rotate(15deg)', rating: 3.9 }
            };

            // --- 4. Frame Definitions ---
            const frameDefinitions = {
                'none': { 
                    name: 'None', 
                    draw: () => {}, 
                    rating: 5.0
                },
                'matte': { 
                    name: 'Matte (White Border)', 
                    draw: (ctx, w, h) => {
                        const borderSize = Math.max(w, h) * 0.05; 
                        ctx.fillStyle = 'rgba(255, 255, 255, 1)'; 
                        ctx.fillRect(0, 0, w, borderSize); 
                        ctx.fillRect(0, h - borderSize, w, borderSize); 
                        ctx.fillRect(0, borderSize, borderSize, h - 2 * borderSize); 
                        ctx.fillRect(w - borderSize, borderSize, borderSize, h - 2 * borderSize); 
                    },
                    rating: 4.7
                },
                'newspaper': { 
                    name: 'Newspaper', 
                    draw: (ctx, w, h) => {
                        const borderSize = Math.max(w, h) * 0.04;
                        ctx.fillStyle = 'rgba(240, 240, 240, 0.5)';
                        ctx.fillRect(0, 0, w, borderSize); 
                        ctx.fillRect(0, 0, borderSize, h); 
                        ctx.fillRect(w - borderSize, 0, borderSize, h); 

                        ctx.strokeStyle = '#000';
                        ctx.lineWidth = Math.max(w, h) * 0.005; 
                        ctx.strokeRect(borderSize, borderSize, w - 2 * borderSize, h - 2 * borderSize);
                        
                        ctx.fillStyle = '#333';
                        ctx.fillRect(borderSize * 2, borderSize + 10, w - borderSize * 4, 3);
                    },
                    rating: 4.0
                },
                'flyer': { 
                    name: 'Flyer (High Contrast)', 
                    draw: (ctx, w, h) => {
                        const borderSize = Math.max(w, h) * 0.03;
                        
                        ctx.fillStyle = 'rgba(255, 68, 68, 1)'; 
                        ctx.fillRect(0, 0, w, borderSize * 2); 
                        ctx.fillRect(0, h - borderSize * 2, w, borderSize * 2);
                        ctx.fillRect(0, borderSize * 2, borderSize * 2, h - 4 * borderSize);
                        ctx.fillRect(w - borderSize * 2, borderSize * 2, borderSize * 2, h - 4 * borderSize);
                        
                        ctx.strokeStyle = '#00aaff';
                        ctx.lineWidth = Math.max(w, h) * 0.01;
                        ctx.strokeRect(borderSize, borderSize, w - 2 * borderSize, h - 2 * borderSize);
                    },
                    rating: 3.5
                },
                // *** POLAROID FRAME FIX ***
                'polaroid': { 
                    name: 'Polaroid', 
                    draw: (ctx, w, h) => {
                        const thin = Math.max(w, h) * 0.02; // Side/top border
                        const thick = Math.max(w, h) * 0.12; // Bottom margin
                        const innerW = w - 2 * thin;
                        const innerH = h - thin - thick;

                        // 1. Draw solid white frame background that covers the photo area.
                        // The original photo is already drawn, so we draw white over the border area.
                        ctx.fillStyle = 'white';
                        
                        // Top bar
                        ctx.fillRect(0, 0, w, thin); 
                        // Bottom bar (the thick part)
                        ctx.fillRect(0, h - thick, w, thick);
                        // Left bar
                        ctx.fillRect(0, thin, thin, innerH);
                        // Right bar
                        ctx.fillRect(w - thin, thin, thin, innerH);
                        
                        // 2. Draw black border around the intended *photo* area
                        ctx.strokeStyle = '#000';
                        ctx.lineWidth = 1;
                        ctx.strokeRect(thin, thin, innerW, innerH);

                        // 3. Add simulated text on the bottom strip (for visual effect)
                        ctx.fillStyle = '#333';
                        ctx.font = `${thick * 0.25}px Arial`;
                        ctx.textAlign = 'center';
                        ctx.fillText("‎ ", w / 2, h - thick / 2);
                    },
                    rating: 4.3
                },
                'golden_ratio': {
                    name: 'Golden Ratio',
                    draw: (ctx, w, h) => {
                        const borderSize = Math.min(w, h) * 0.02;
                        
                        ctx.fillStyle = 'rgba(255, 215, 0, 0.8)'; 
                        ctx.fillRect(0, 0, w, borderSize); 
                        ctx.fillRect(0, h - borderSize, w, borderSize); 
                        ctx.fillRect(0, borderSize, borderSize, h - 2 * borderSize); 
                        ctx.fillRect(w - borderSize, borderSize, borderSize, h - 2 * borderSize); 

                        ctx.strokeStyle = '#DAA520'; 
                        ctx.lineWidth = borderSize / 4;
                        ctx.strokeRect(borderSize / 2, borderSize / 2, w - borderSize, h - borderSize);
                    },
                    rating: 4.5
                },
                'dark_wood': {
                    name: 'Dark Wood',
                    draw: (ctx, w, h) => {
                        const borderSize = Math.max(w, h) * 0.04;
                        
                        ctx.fillStyle = '#443322';
                        ctx.fillRect(0, 0, w, borderSize); 
                        ctx.fillRect(0, h - borderSize, w, borderSize); 
                        ctx.fillRect(0, borderSize, borderSize, h - 2 * borderSize); 
                        ctx.fillRect(w - borderSize, borderSize, borderSize, h - 2 * borderSize); 

                        ctx.strokeStyle = '#888';
                        ctx.lineWidth = 1;
                        ctx.strokeRect(borderSize - 1, borderSize - 1, w - 2 * borderSize + 2, h - 2 * borderSize + 2);

                    },
                    rating: 4.1
                },
                'film_strip': {
                    name: 'Film Strip',
                    draw: (ctx, w, h) => {
                        const stripHeight = Math.min(w, h) * 0.05;
                        const holeSize = stripHeight * 0.3;
                        const gap = stripHeight * 0.2;
                        
                        ctx.fillStyle = '#111'; 

                        ctx.fillRect(0, 0, w, stripHeight);
                        for(let x = gap; x < w - stripHeight; x += holeSize + gap) {
                            ctx.fillStyle = '#333'; 
                            ctx.fillRect(x + holeSize/4, stripHeight * 0.3, holeSize/2, stripHeight * 0.4);
                        }

                        ctx.fillRect(0, h - stripHeight, w, stripHeight);
                        for(let x = gap; x < w - stripHeight; x += holeSize + gap) {
                            ctx.fillStyle = '#333';
                            ctx.fillRect(x + holeSize/4, h - stripHeight * 0.7, holeSize/2, stripHeight * 0.4);
                        }
                    },
                    rating: 3.8
                }
            };
            
            // --- 5. Ratio Definitions ---
            const ratioDefinitions = {
                'free': { name: 'Original', w: null, h: null, className: 'ratio-free' },
                '1-1': { name: 'Square (1:1)', w: 1, h: 1, className: 'ratio-1-1' },
                '4-3': { name: '4:3', w: 4, h: 3, className: 'ratio-4-3' },
                '3-2': { name: '3:2', w: 3, h: 2, className: 'ratio-3-2' },
                '16-9': { name: 'Landscape (16:9)', w: 16, h: 9, className: 'ratio-16-9' },
                '9-16': { name: 'Story (9:16)', w: 9, h: 16, className: 'ratio-9-16' },
                '5-4': { name: '5:4', w: 5, h: 4, className: 'ratio-5-4' },
            };

            // Helper function to generate star rating HTML
            function getRatingStars(rating) {
                const fullStars = Math.floor(rating);
                const halfStar = rating % 1 >= 0.5 ? '½' : '';
                const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);

                let html = '';
                for (let i = 0; i < fullStars; i++) {
                    html += '★';
                }
                if (halfStar) {
                    html += halfStar;
                }
                for (let i = 0; i < emptyStars; i++) {
                    html += '<span style="color: var(--bg-dark-3);">★</span>';
                }
                return html;
            }


            // --- 6. Core Functions ---
            
            function resetEditorState() {
                // 1. Reset filters
                activeFilters = [];
                updateFilterStackUI();

                // 2. Reset frame
                activeFrame = 'none';
                updateFrameGridUI();

                // 3. Reset crop
                activeRatio = 'free';
                applyCropRatio('free'); 
                updateRatioGridUI(); 

                // 4. Reset adjustment state & sliders
                adjustmentSettings = {
                    brightness: 100,
                    contrast: 100,
                    saturation: 100,
                    sepia: 0
                };
                brightnessSlider.value = 100;
                contrastSlider.value = 100;
                saturationSlider.value = 100;
                sepiaSlider.value = 0;
                updateAdjustmentValues();

                // 5. Reset text state & UI
                textSettings = {
                    content: '',
                    font: 'Arial',
                    size: 40,
                    color: '#FFFFFF',
                    pos: { x: originalImage ? originalImage.naturalWidth / 2 : 0, y: originalImage ? originalImage.naturalHeight / 2 : 0 }
                };
                textInput.value = '';
                fontSelect.value = 'Arial';
                fontSizeInput.value = '40';
                colorInput.value = '#FFFFFF';
                colorHexInput.value = '#FFFFFF';
                // Center text position on reset
                if (originalImage) {
                    textSettings.pos.x = originalImage.naturalWidth / 2;
                    textSettings.pos.y = originalImage.naturalHeight / 2;
                }

                // 6. Initial render
                renderCanvas();
            }

            function getCombinedFilterString() {
                const baseFilter = activeFilters.map(key => filterDefinitions[key].css).join(' ');
                const adjFilter = `brightness(${adjustmentSettings.brightness}%) contrast(${adjustmentSettings.contrast}%) saturate(${adjustmentSettings.saturation}%) sepia(${adjustmentSettings.sepia}%)`;
                
                const combined = baseFilter + ' ' + adjFilter;
                return combined.trim() || 'none';
            }

            function drawFrame() {
                if (activeFrame === 'none' || !frameDefinitions[activeFrame]) return;

                const frame = frameDefinitions[activeFrame];
                const w = canvas.width;
                const h = canvas.height;

                ctx.save();
                frame.draw(ctx, w, h); 
                ctx.restore();
            }


            /**
             * Main render function. Bakes filters and text directly into the canvas.
             */
            function renderCanvas() {
                if (!originalImage) return;

                // 1. Set canvas dimensions to Original Image Size
                canvas.width = originalImage.naturalWidth;
                canvas.height = originalImage.naturalHeight;

                // 2. Clear canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // 3. Apply filter string to context
                const filterString = getCombinedFilterString();
                ctx.filter = filterString;
                
                // 4. Draw image (this will be filtered)
                ctx.drawImage(originalImage, 0, 0, canvas.width, canvas.height);

                // 5. Draw the Frame on top of the filtered image
                ctx.filter = 'none'; // Ensure frame drawing itself isn't filtered
                drawFrame(); 
                ctx.filter = 'none'; // Reset just in case

                // 6. Draw Text (on top of everything)
                if (textSettings.content) {
                    ctx.font = `${textSettings.size}px ${textSettings.font}`;
                    ctx.fillStyle = textSettings.color;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    
                    ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                    ctx.shadowBlur = 5;
                    ctx.shadowOffsetX = 2;
                    ctx.shadowOffsetY = 2;

                    ctx.fillText(textSettings.content, textSettings.pos.x, textSettings.pos.y);
                    
                    ctx.shadowColor = 'transparent';
                    ctx.shadowBlur = 0;
                    ctx.shadowOffsetX = 0;
                    ctx.shadowOffsetY = 0;
                }
            }
            
            function updateAdjustmentValues() {
                brightnessValue.textContent = `${adjustmentSettings.brightness}%`;
                contrastValue.textContent = `${adjustmentSettings.contrast}%`;
                saturationValue.textContent = `${adjustmentSettings.saturation}%`;
                sepiaValue.textContent = `${adjustmentSettings.sepia}%`;
            }

            function renderFinalImageForDownload() {
                return new Promise((resolve) => {
                    if (!originalImage) return resolve(null);
                    
                    // NOTE: The crop is currently only visual (CSS). True canvas cropping logic 
                    // should be implemented here if a ratio is active.
                    canvas.toBlob((blob) => {
                        resolve(blob);
                    }, 'image/png');
                });
            }

            function handleImageUpload(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    originalImage = new Image();
                    originalImage.onload = () => {
                        // Set canvas to image's original ratio and size
                        canvas.style.width = '100%';
                        canvas.style.height = 'auto';
                        canvas.width = originalImage.naturalWidth;
                        canvas.height = originalImage.naturalHeight;

                        // Reset UI and state
                        resetEditorState();
                        
                        // Hide prompt, show UI
                        uploadPrompt.classList.add('hidden');
                        filterStackUI.style.display = 'flex';
                        tabButtons.forEach(btn => btn.disabled = false);

                        renderCanvas();
                    };
                    originalImage.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }

            function populateFilters() {
                filterGrid.innerHTML = '';
                
                // Convert to array for sorting, then sort by name
                const sortedFilters = Object.entries(filterDefinitions)
                    .map(([key, filter]) => ({ key, ...filter }))
                    .sort((a, b) => a.name.localeCompare(b.name));

                sortedFilters.forEach(filter => {
                    const item = document.createElement('div');
                    item.className = 'grid-item filter-item';
                    item.dataset.filterKey = filter.key;
                    
                    const preview = document.createElement('div');
                    preview.className = 'grid-preview filter-preview';
                    preview.style.filter = filter.css; 
                    preview.innerHTML = `<span>${filter.name.substring(0, 1)}</span>`; 

                    const name = document.createElement('span');
                    name.className = 'item-name filter-name';
                    name.textContent = filter.name;
                    
                    const ratingDiv = document.createElement('div');
                    ratingDiv.className = 'filter-rating';
                    ratingDiv.innerHTML = getRatingStars(filter.rating);

                    item.appendChild(preview);
                    item.appendChild(name);
                    item.appendChild(ratingDiv);
                    filterGrid.appendChild(item);

                    item.addEventListener('click', () => addFilter(filter.key));
                });
            }
            
            function populateFrames() {
                frameGrid.innerHTML = '';
                for (const key in frameDefinitions) {
                    const frame = frameDefinitions[key];
                    const item = document.createElement('div');
                    item.className = 'grid-item frame-item';
                    item.dataset.frameKey = key;
                    
                    const preview = document.createElement('div');
                    preview.className = 'grid-preview frame-preview';
                    preview.dataset.key = key; 
                    preview.innerHTML = `<span>${frame.name.substring(0, 1)}</span>`; 

                    const name = document.createElement('span');
                    name.className = 'item-name frame-name';
                    name.textContent = frame.name;
                    
                    item.appendChild(preview);
                    item.appendChild(name);
                    frameGrid.appendChild(item);

                    item.addEventListener('click', () => setActiveFrame(key));
                }
            }

            function populateRatios() {
                ratioGrid.innerHTML = '';
                for (const key in ratioDefinitions) {
                    const ratio = ratioDefinitions[key];
                    const item = document.createElement('div');
                    item.className = 'ratio-item';
                    item.dataset.ratioKey = key;

                    const preview = document.createElement('div');
                    preview.className = `ratio-preview ${ratio.className}`;
                    preview.textContent = ratio.name.includes('(') ? ratio.name.substring(0, ratio.name.indexOf('(')).trim() : ratio.name;

                    const name = document.createElement('span');
                    name.className = 'item-name';
                    name.textContent = ratio.name;

                    item.appendChild(preview);
                    item.appendChild(name);
                    ratioGrid.appendChild(item);

                    item.addEventListener('click', () => applyCropRatio(key));
                }
            }

            function applyCropRatio(ratioKey) {
                activeRatio = ratioKey;
                const ratio = ratioDefinitions[ratioKey];
                
                // --- Visual Crop Logic (CSS-based) ---
                if (ratio.w && originalImage) {
                    previewArea.classList.add('cropping');
                    
                    canvas.style.maxWidth = '100%';
                    canvas.style.maxHeight = '100%';
                    canvas.style.width = '100%';
                    canvas.style.height = 'auto'; 

                    if (ratio.w >= ratio.h) {
                        canvas.style.aspectRatio = `${ratio.w} / ${ratio.h}`;
                        canvas.style.height = 'auto';
                    } else {
                        canvas.style.aspectRatio = `${ratio.w} / ${ratio.h}`;
                        canvas.style.width = 'auto';
                        canvas.style.maxHeight = '100%';
                    }
                    
                } else {
                    // Freeform/None
                    previewArea.classList.remove('cropping');
                    canvas.style.aspectRatio = 'initial';
                    canvas.style.width = '100%';
                    canvas.style.height = 'auto';
                }

                updateRatioGridUI();
            }

            function setActiveFrame(frameKey) {
                activeFrame = frameKey;
                updateFrameGridUI();
                renderCanvas();
            }

            function updateFrameGridUI() {
                document.querySelectorAll('.frame-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.frameKey === activeFrame);
                });
            }

            function updateRatioGridUI() {
                document.querySelectorAll('.ratio-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.ratioKey === activeRatio);
                });
            }

            function updateFilterStackUI() {
                stackSlots.forEach((slot, index) => {
                    const filterKey = activeFilters[index];
                    if (filterKey) {
                        slot.textContent = filterDefinitions[filterKey].name;
                        slot.classList.add('filled');
                        if (!slot.querySelector('.remove-filter-btn')) {
                            const removeBtn = document.createElement('button');
                            removeBtn.className = 'remove-filter-btn';
                            removeBtn.title = 'Remove filter';
                            removeBtn.innerHTML = '<svg><use href="#icon-x"></use></svg>';
                            removeBtn.onclick = (e) => {
                                e.stopPropagation();
                                removeFilter(index);
                            };
                            slot.appendChild(removeBtn);
                        }
                    } else {
                        slot.textContent = 'Empty';
                        slot.classList.remove('filled');
                        const removeBtn = slot.querySelector('.remove-filter-btn');
                        if (removeBtn) {
                            slot.removeChild(removeBtn);
                        }
                    }
                });

                const isFull = activeFilters.length >= 3;
                document.querySelectorAll('.filter-item').forEach(item => {
                    const filterKey = item.dataset.filterKey;
                    const isApplied = activeFilters.includes(filterKey);
                    
                    item.classList.toggle('disabled', isFull && !isApplied);
                });
            }

            function addFilter(filterKey) {
                if (activeFilters.length < 3) {
                    if (!activeFilters.includes(filterKey)) {
                        activeFilters.push(filterKey);
                        updateFilterStackUI();
                        renderCanvas();
                    }
                } else {
                    console.warn("Filter stack is full (max 3).");
                }
            }

            function removeFilter(index) {
                activeFilters.splice(index, 1);
                updateFilterStackUI();
                renderCanvas();
            }

            function resetAllFilters() {
                activeFilters = [];
                updateFilterStackUI();
                renderCanvas();
            }

            function switchTab(e) {
                const targetPanel = e.currentTarget.dataset.panel;

                if (targetPanel === 'crop-panel') {
                    if (activeRatio !== 'free') {
                        previewArea.classList.add('cropping');
                    }
                } else {
                    previewArea.classList.remove('cropping');
                }

                tabButtons.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.panel === targetPanel);
                });

                panels.forEach(panel => {
                    panel.classList.toggle('active', panel.id === targetPanel);
                });
            }
            
            function formatFileSize(bytes) {
                if (bytes === null) return "Calculating size..."; // Handle null state
                if (bytes < 1024) {
                    return `File Size: ${bytes} Bytes`;
                } else if (bytes < 1024 * 1024) {
                    return `File Size: ${(bytes / 1024).toFixed(2)} KB`;
                } else {
                    return `File Size: ${(bytes / (1024 * 1024)).toFixed(2)} MB`;
                }
            }

            // --- 7. Event Listeners ---

            // File Upload
            uploadPrompt.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleImageUpload);

            // Replace Photo Button
            replacePhotoBtn.addEventListener('click', () => fileInput.click());

            // Tab Navigation
            tabButtons.forEach(btn => btn.addEventListener('click', switchTab));

            // Filter Stack
            resetFiltersBtn.addEventListener('click', resetAllFilters);

            // Adjustment Sliders
            brightnessSlider.addEventListener('input', (e) => {
                adjustmentSettings.brightness = parseInt(e.target.value, 10);
                updateAdjustmentValues();
                renderCanvas();
            });
            contrastSlider.addEventListener('input', (e) => {
                adjustmentSettings.contrast = parseInt(e.target.value, 10);
                updateAdjustmentValues();
                renderCanvas();
            });
            saturationSlider.addEventListener('input', (e) => {
                adjustmentSettings.saturation = parseInt(e.target.value, 10);
                updateAdjustmentValues();
                renderCanvas();
            });
            sepiaSlider.addEventListener('input', (e) => {
                adjustmentSettings.sepia = parseInt(e.target.value, 10);
                updateAdjustmentValues();
                renderCanvas();
            });


            // Text Controls
            textInput.addEventListener('input', (e) => {
                textSettings.content = e.target.value;
                renderCanvas();
            });
            fontSelect.addEventListener('change', (e) => {
                textSettings.font = e.target.value;
                renderCanvas();
            });
            fontSizeInput.addEventListener('input', (e) => {
                textSettings.size = parseInt(e.target.value, 10);
                renderCanvas();
            });
            colorInput.addEventListener('input', (e) => {
                textSettings.color = e.target.value;
                colorHexInput.value = e.target.value;
                renderCanvas();
            });
            colorHexInput.addEventListener('input', (e) => {
                const val = e.target.value;
                if (/^#[0-9A-F]{6}$/i.test(val) || /^#[0-9A-F]{3}$/i.test(val)) {
                    textSettings.color = val;
                    colorInput.value = val;
                    renderCanvas();
                }
            });

            // Text Position Controls
            const moveStep = 10;
            btnPosUp.addEventListener('click', () => {
                textSettings.pos.y = Math.max(textSettings.pos.y - moveStep, 0); // Constrain
                renderCanvas();
            });
            btnPosDown.addEventListener('click', () => {
                textSettings.pos.y = Math.min(textSettings.pos.y + moveStep, canvas.height); // Constrain
                renderCanvas();
            });
            btnPosLeft.addEventListener('click', () => {
                textSettings.pos.x = Math.max(textSettings.pos.x - moveStep, 0); // Constrain
                renderCanvas();
            });
            btnPosRight.addEventListener('click', () => {
                textSettings.pos.x = Math.min(textSettings.pos.x + moveStep, canvas.width); // Constrain
                renderCanvas();
            });
            btnPosCenter.addEventListener('click', () => {
                if (originalImage) {
                    textSettings.pos.x = canvas.width / 2;
                    textSettings.pos.y = canvas.height / 2;
                    renderCanvas();
                }
            });

            // Download Process
            generateDownloadBtn.addEventListener('click', async () => {
                fileSizeInfo.textContent = 'Calculating size...';
                fileSizeInfo.classList.add('visible'); // Show calculating text
                modalOverlay.classList.add('visible');
                
                const blob = await renderFinalImageForDownload();
                
                if (downloadBlobUrl) {
                    URL.revokeObjectURL(downloadBlobUrl);
                }
                
                downloadBlobUrl = URL.createObjectURL(blob);
                fileSizeInfo.textContent = formatFileSize(blob.size);
            });

            modalCancelBtn.addEventListener('click', () => {
                modalOverlay.classList.remove('visible');
                fileSizeInfo.classList.remove('visible'); // Hide info on cancel
                if (downloadBlobUrl) {
                    URL.revokeObjectURL(downloadBlobUrl);
                    downloadBlobUrl = null;
                }
            });

            modalConfirmBtn.addEventListener('click', () => {
                if (downloadBlobUrl) {
                    const link = document.createElement('a');
                    link.href = downloadBlobUrl;
                    link.download = `edited-photo-${Date.now()}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
                modalOverlay.classList.remove('visible');
                fileSizeInfo.classList.remove('visible'); // Hide info on download
            });

            // --- 8. Initialization ---
            populateFilters();
            populateFrames(); 
            populateRatios(); 
            updateFrameGridUI();
            updateRatioGridUI();
            updateAdjustmentValues();

        });
    </script>
</body>
</html>
